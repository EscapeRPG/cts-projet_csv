{% extends 'base.html.twig' %}

{% block title %}Suivi contrôleurs{% endblock %}

{% block body %}
    {% include 'partials/year-filter.html.twig' %}

    <div class="suivi-container">
        {% include 'partials/filters.html.twig' %}

        {% set stats = {
            'nb_controles': 'Nombre de contrôles',
            'prix_moyen': 'Prix moyen',
            'temps_moyen': 'Temps moyen',
            'taux_refus': 'Taux de refus',
        } %}

        <div class="stats-container">
            {% for key, label in stats %}
                <div class="stats-wrapper">
                    <div class="stats-panel">
                        <h2>{{ label }}</h2>

                        {% set values = [] %}

                        {% for c in controleursStats %}
                            {% set values = values | merge([c[key]]) %}
                        {% endfor %}

                        {% set maxValue = values ? max(values) : 0 %}
                        {% set moyenne = values ? moyennesGlobales[key] : 0 %}
                        {% set moyennePercent = maxValue > 0 ? (moyenne / maxValue) * 100 : 0 %}

                        <div class="salaries-chart">
                            <div class="chart-cols names">
                                {% for salarie in controleursStats | sort((a, b) => b[key] <=> a[key]) %}
                                    <div class="salarie-name">{{ salarie.nom }}</div>
                                {% endfor %}
                            </div>

                            <div class="chart-cols bars">
                                {% for salarie in controleursStats | sort((a, b) => b[key] <=> a[key]) %}
                                    {% set percent = maxValue > 0 ? (salarie[key] / maxValue) * 100 : 0 %}

                                    <div class="bar-container">
                                        <div class="bar" style="width: {{ percent }}%"></div>
                                    </div>
                                {% endfor %}

                                <div class="avg-line" style="left: {{ moyennePercent }}%">
                                    <span>
                                        {% if key == 'prix_moyen' %}
                                            {{ moyenne|number_format(2, ',', '.') }} €
                                        {% elseif key == 'temps_moyen' %}
                                            {{ moyenne|number_format(2, '\'', '.') }}
                                        {% elseif key == 'taux_refus' %}
                                            {{ moyenne|number_format(2, ',', '.') }}%
                                        {% else %}
                                            {{ moyenne|number_format(2, ',', '.') }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="chart-cols nb">
                                {% for salarie in controleursStats | sort((a, b) => b[key] <=> a[key]) %}
                                    <div class="salarie-row">
                                        <div class="salarie-value">
                                            {% if key == 'nb_controles' %}
                                                {{ salarie[key] }}
                                            {% elseif key == 'prix_moyen' %}
                                                {{ salarie[key]|number_format(2, ',', '.') }} €
                                            {% elseif key == 'temps_moyen' %}
                                                {{ salarie[key]|number_format(2, '\'', '.') }}
                                            {% elseif key == 'taux_refus' %}
                                                {{ salarie[key]|number_format(2, ',', '.') }}%
                                            {% else %}
                                                {{ salarie[key]|number_format(2, ',', '.') }}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}

            <div class="stats-wrapper">
                <div class="stats-panel">
                    <h2>Répartition particuliers / professionnels</h2>

                    <div class="salaries-chart">
                        <div class="chart-cols names">
                            {% for salarie in controleursStats | sort((a,b) => a.nom <=> b.nom) %}
                                <div class="salarie-name">{{ salarie.nom }}</div>
                            {% endfor %}
                        </div>

                        <div class="repartition-bars bars">
                            {% for salarie in controleursStats | sort((a,b) => a.nom <=> b.nom) %}
                                {% set total = salarie.nb_particuliers + salarie.nb_professionnels %}
                                {% set pct_part = total > 0 ? (salarie.nb_particuliers / total) * 100 : 0 %}
                                {% set pct_pro = total > 0 ? (salarie.nb_professionnels / total) * 100 : 0 %}

                                <div class="repartition-bars-container stacked-bar">
                                    <div class="bar-part" style="width: {{ pct_part }}%">
                                        {{ pct_part > 0 ? pct_part|number_format(2, ',', '.') ~ '%' : '' }}
                                    </div>
                                    <div class="bar-pro" style="width: {{ pct_pro }}%">
                                        {{ pct_pro > 0 ? pct_pro|number_format(2, ',', '.') ~ '%' : '' }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
